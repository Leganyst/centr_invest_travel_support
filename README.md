# Ростовский маршрут за день — MVP

Телеграм-бот, который собирает предпочтения пользователя и возвращает однодневный маршрут по Ростову-на-Дону (5–7 остановок) вместе с готовым `.ics` файлом для календаря. При желании можно подключить LLM, чтобы вести диалог и объяснять выбор точек. Источник мест — 2ГИС (радиус до 2 км от пользователя) с кэшем и сидовыми данными на случай отсутствия ключа.

## Как это работает
1. Пользователь пишет боту `/plan` и отвечает на вопросы (кнопками или через LLM `/llm/next`).
2. Бот отправляет запрос на бэкенд.
3. Бэкенд подтягивает места из 2ГИС рядом с пользователем (или из seed JSON), строит маршрут и готовит ICS.
4. Бот возвращает список остановок, файл календаря и (опционально) объяснение маршрута через `/llm/explain`.

## Как запустить
1. Скопируйте `.env.example` в `.env` в корне и в директории `bot/`. Укажите `TELEGRAM_BOT_TOKEN`. При наличии ключа 2ГИС заполните `DGIS_API_KEY`. Для веб-интерфейса задайте публичный `MAPGL_PUBLIC_KEY` из кабинета 2ГИС (ограничьте по домену).
2. (Опционально) добавьте `LLM_API_BASE`, `LLM_API_KEY`, `LLM_MODEL`, чтобы активировать диалог и объяснения на основе LLM.
3. Запустите `docker compose -f deploy/docker-compose.yml up -d` или локально `uvicorn app:app --reload`.
4. Подключитесь к боту и отправьте `/start` → `/plan` или откройте `http://localhost:8080` для UI.

## Веб-интерфейс
- Mobile-first SPA раздаётся FastAPI по корню `/`: карта 2ГИС, список остановок, кнопки «Скачать .ics» и «Объяснить».
- Модалки «Предпочтения» и «Чат» используют REST-ручки `/plan`, `/llm/next`, `/llm/explain`.
- Нижняя панель отображает статус источника данных (2ГИС или сиды) и оптимизации маршрута.
- Старт без геопозиции идёт от центра Ростова-на-Дону, на карте подсвечивается эта точка.
- MapGL требует отдельного публичного ключа (`MAPGL_PUBLIC_KEY`). Для локального запуска можно оставить `demo`, но для продакшена выпусти свой ключ и добавь точные origin/рефереры (`http://127.0.0.1:8000`, `http://localhost:8000`).

Полный reference по REST-эндпоинтам — в `docs/api.md`.

## Что реализовано
- Однодневный маршрут на основе 2ГИС (радиус поиска) и/или seed JSON.
- Простая эвристика порядка и времени посещений.
- Генерация ICS прямо в ответе `/plan`.
- Ручки `/llm/next` и `/llm/explain` с fallback-логикой на случай, если ключа LLM нет.
- Дополнительный эндпоинт `/plan/ics` для прямой выгрузки календаря.

## Что не реализовано
- Бронирования и оплату.
- Сложные рекомендации и ML-модели для маршрутизации.
- Офлайн-карты и работу без связи.

## Ограничения
- Время в пути оценивается приближённо (haversine + грубая конверсия).
- Ключ 2ГИС демо ограничен радиусом 2 км и числом запросов — поэтому добавлен диск-кэш.
- Если LLM не настроен, диалог строится по заранее описанному сценарию.
